<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="admin no-animations">
    <div class="container-fluid">
        <div class="row">
            <nav class="col-lg-2 col-md-3 d-md-block sidebar py-4">
                <div class="navbar-brand mb-4 text-center">Conagopare Admin</div>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'oficios' else '' }}" href="#" onclick="showSection('oficios')">
                            <i class="bi bi-archive me-2"></i>Resumen de Oficios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'usuarios' else '' }}" href="#" onclick="showSection('usuarios')">
                            <i class="bi bi-people me-2"></i>Gestión de Usuarios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'tipos_asesoria' else '' }}" href="#" onclick="showSection('tipos_asesoria')">
                            <i class="bi bi-list-check me-2"></i>Gestión de Tipos de Asesoría
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'parroquias' else '' }}" href="#" onclick="showSection('parroquias')">
                            <i class="bi bi-geo-alt me-2"></i>Gestión de Parroquias
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                        </a>
                    </li>
                </ul>
            </nav>
            <main class="col-lg-10 col-md-9 ms-sm-auto main-content">
                <div class="container-fluid">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible show"
                        role="alert">
                        {{ message }}
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <div id="section-oficios" class="card card-section {{ 'active' if current_section == 'oficios' else 'd-none' }}">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-archive me-2"></i>Resumen de Oficios
                        </div>
                        <div class="card-body">
                            {% if oficios %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Número Oficio</th>
                                            <th>Estado</th>
                                            <th>Técnico</th>
                                            <th>Sub-Estado</th>
                                            <th>Fecha Recibido</th>
                                            <th>Fecha Enviado</th>
                                            <th>Fecha Designación</th>
                                            <th>Anexos</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for oficio in oficios %}
                                        <tr>
                                            <td>{{ oficio.id_secuencial }}</td>
                                            <td>{{ oficio.numero_oficio }}</td>
                                            <td>{{ oficio.estado }}</td>
                                            <td>
                                                {% if oficio.assignments %}
                                                {% for a in oficio.assignments %}
                                                {{ a.tecnico }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                                {% else %}
                                                Pendiente
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if oficio.assignments %}
                                                {% for a in oficio.assignments %}
                                                {{ a.sub_estado or 'Asignado' }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                                {% else %}
                                                N/A
                                                {% endif %}
                                            </td>
                                            <td>{{ oficio.fecha_recibido_formatted }}</td>
                                            <td>{{ oficio.fecha_enviado_formatted }}</td>
                                            <td>{{ oficio.fecha_designacion_formatted or 'N/A' }}</td>
                                            <td>
                                                {% set has_anexo = false %}
                                                {% for a in oficio.assignments %}
                                                {% if a.anexo_nombre %}
                                                {% set has_anexo = true %}
                                                {% endif %}
                                                {% endfor %}
                                                {{ 'True' if has_anexo else 'False' }}
                                                {% if has_anexo %}
                                                <div>
                                                    {% for a in oficio.assignments %}
                                                    {% if a.anexo_nombre %}
                                                    <button type="button" class="btn btn-primary btn-sm preview-btn"
                                                        data-bs-toggle="modal" data-bs-target="#previewModal"
                                                        data-id="{{ oficio._id }}"
                                                        data-anexo-nombre="{{ a.anexo_nombre }}"
                                                        data-anexo-tecnico="{{ a.tecnico }}">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <a href="{{ url_for('download_anexo', oficio_id=oficio._id, tecnico=a.tecnico) }}"
                                                        class="btn btn-info btn-sm" title="Descargar {{ a.anexo_nombre }}">
                                                        <i class="bi bi-download"></i>
                                                    </a>
                                                    {% endif %}
                                                {% endfor %}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm edit-btn"
                                                    data-bs-toggle="modal" data-bs-target="#editModal"
                                                    data-id="{{ oficio._id }}"
                                                    data-fecha-enviado="{{ oficio.fecha_enviado }}"
                                                    data-numero-oficio="{{ oficio.numero_oficio }}"
                                                    data-gad-parroquial="{{ oficio.gad_parroquial }}"
                                                    data-canton="{{ oficio.canton }}"
                                                    data-detalle="{{ oficio.detalle }}"
                                                    data-assignments="{{ oficio.assignments | default([]) | tojson }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="oficio_id" value="{{ oficio._id }}">
                                                    <input type="hidden" name="current_section" value="oficios">
                                                    <button type="submit" class="btn btn-danger btn-sm"
                                                        name="delete_oficio"
                                                        onclick="return confirm('¿Está seguro de eliminar este registro?')"><i
                                                            class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                {% if oficio.archivo_nombre %}
                                                <a href="{{ url_for('download', oficio_id=oficio._id) }}" class="btn btn-sm btn-info">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">Sin oficios registrados.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div id="section-usuarios" class="card card-section {{ 'active' if current_section == 'usuarios' else 'd-none' }}">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-people me-2"></i>Gestión de Usuarios
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Crear Usuario</h5>
                            <form method="POST" class="mb-4">
                                <input type="hidden" name="current_section" value="usuarios">
                                <div class="row g-3 mb-2">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" name="nombre" placeholder="Nombre"
                                            required>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" name="apellido" placeholder="Apellido"
                                            required>
                                    </div>
                                </div>
                                <div class="row g-3 mb-2">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" name="username"
                                            placeholder="Nombre de usuario" required>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="password" class="form-control" name="password"
                                            placeholder="Contraseña" required>
                                    </div>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-6">
                                        <select class="form-select" name="role" required>
                                            <option value="">Seleccione Rol</option>
                                            {% for role in roles %}
                                            <option value="{{ role }}">{{ role }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-success w-100" name="create_user">
                                            <i class="bi bi-person-plus"></i> Crear
                                        </button>
                                    </div>
                                </div>
                            </form>

                            <h5 class="card-title mt-4">Editar Usuarios</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Apellido</th>
                                            <th>Usuario</th>
                                            <th>Rol</th>
                                            <th>Contraseña</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <form method="POST">
                                            <input type="hidden" name="user_id" value="{{ user._id }}">
                                            <input type="hidden" name="current_section" value="usuarios">
                                            <tr>
                                                <td>
                                                    <input type="text" class="form-control" name="nombre"
                                                        value="{{ user.nombre or '' }}" placeholder="Nombre" required>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" name="apellido"
                                                        value="{{ user.apellido or '' }}" placeholder="Apellido"
                                                        required>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" name="username"
                                                        value="{{ user.username or '' }}" required
                                                        placeholder="Username">
                                                </td>
                                                <td>
                                                    <select class="form-select" name="role" required>
                                                        {% for role in roles %}
                                                        <option value="{{ role }}" {% if user.role==role %}selected{%
                                                            endif %}>{{ role }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="password" class="form-control" name="password"
                                                        placeholder="Nueva contraseña (opcional)">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="5" class="text-center pb-3">
                                                    <button type="submit" class="btn btn-primary btn-sm me-2"
                                                        name="edit_user">
                                                        <i class="bi bi-save"></i>
                                                    </button>
                                                    <button type="submit" class="btn btn-danger btn-sm"
                                                        name="delete_user"
                                                        onclick="return confirm('¿Está seguro de eliminar este usuario?')"
                                                        {% if user.username==session.user %}disabled{% endif %}>
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </form>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="section-tipos_asesoria" class="card card-section {{ 'active' if current_section == 'tipos_asesoria' else 'd-none' }}">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-list-check me-2"></i>Gestión de Tipos de Asesoría
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Añadir Tipo de Asesoría</h5>
                            <form method="POST" class="mb-4">
                                <input type="hidden" name="current_section" value="tipos_asesoria">
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="nombre"
                                        placeholder="Nombre del tipo de asesoría" required>
                                </div>
                                <button type="submit" class="btn btn-success" name="add_tipo_asesoria">Añadir</button>
                            </form>

                            <h5 class="card-title">Tipos de Asesoría Existentes</h5>
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tipo in tipos_asesoria %}
                                    <tr>
                                        <form method="POST" id="form-tipo-{{ tipo._id }}">
                                            <input type="hidden" name="tipo_id" value="{{ tipo._id }}">
                                            <input type="hidden" name="current_section" value="tipos_asesoria">
                                            <td>
                                                <input type="text" class="form-control" name="edit_nombre"
                                                    value="{{ tipo.nombre }}" id="input-tipo-{{ tipo._id }}" readonly
                                                    required>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm me-2"
                                                    onclick="enableEdit('{{ tipo._id }}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="submit" class="btn btn-success btn-sm d-none"
                                                    name="edit_tipo_asesoria" id="save-tipo-{{ tipo._id }}">
                                                    <i class="bi bi-save"></i>
                                                </button>
                                                <button type="submit" class="btn btn-danger btn-sm"
                                                    name="delete_tipo_asesoria"
                                                    onclick="return confirm('¿Está seguro de eliminar este tipo de asesoría?')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </form>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="section-parroquias" class="card card-section {{ 'active' if current_section == 'parroquias' else 'd-none' }}">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-geo-alt me-2"></i>Gestión de Parroquias
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Añadir Parroquia</h5>
                            <form method="POST" class="mb-4">
                                <input type="hidden" name="current_section" value="parroquias">
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="parroquia" placeholder="Parroquia"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="canton" placeholder="Cantón" required>
                                </div>
                                <button type="submit" class="btn btn-success" name="add_parroquia">Añadir</button>
                            </form>

                            <h5 class="card-title">Editar Parroquias</h5>
                            {% for p in parroquias %}
                            <form method="POST" class="mb-3">
                                <input type="hidden" name="parroquia_id" value="{{ p._id }}">
                                <input type="hidden" name="current_section" value="parroquias">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" name="edit_parroquia"
                                            value="{{ p.parroquia }}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" name="edit_canton"
                                            value="{{ p.canton }}" required>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary w-100" name="edit_parroquia">
                                            <i class="bi bi-save"></i>
                                        </button>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-danger w-100" name="delete_parroquia"
                                            onclick="return confirm('¿Está seguro de eliminar esta parroquia?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Oficio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" id="editForm" enctype="multipart/form-data">
                        <input type="hidden" name="oficio_id" id="edit_oficio_id">
                        <input type="hidden" name="current_section" value="oficios">
                        <div class="mb-3">
                            <label for="edit_fecha_enviado" class="form-label">Fecha Enviado</label>
                            <input type="date" class="form-control" name="fecha_enviado" id="edit_fecha_enviado"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_numero_oficio" class="form-label">Número de Oficio</label>
                            <input type="text" class="form-control" name="numero_oficio" id="edit_numero_oficio"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_gad_parroquial" class="form-label">GAD Parroquial</label>
                            <select class="form-select" name="gad_parroquial" id="edit_gad_parroquial" required
                                onchange="updateCantonEdit()">
                                <option value="">Seleccione GAD Parroquial</option>
                                {% for p in parroquias %}
                                <option value="{{ p.parroquia }}">{{ p.parroquia }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_canton" class="form-label">Cantón</label>
                            <input type="text" class="form-control" name="canton" id="edit_canton" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_detalle" class="form-label">Detalle</label>
                            <textarea class="form-control" name="detalle" id="edit_detalle" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Asignaciones</label>
                            <div id="edit_tecnico_asesoria_pairs">
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm mt-2 add-pair">Añadir
                                Asignación</button>
                        </div>
                        <div class="mb-3">
                            <label for="edit_archivo" class="form-label">Subir Archivo (opcional)</label>
                            <input type="file" class="form-control" id="edit_archivo" name="archivo" accept=".pdf,.doc,.docx,.jpg,.png">
                        </div>
                        <button type="submit" class="btn btn-primary" name="edit_oficio">Actualizar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Vista Previa del Anexo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContainer">
                        <iframe id="previewFrame" title="Vista previa del archivo" style="width: 100%; height: 500px;"></iframe>
                        <div id="previewError" class="d-none text-danger text-center">
                            No se puede mostrar la vista previa del archivo. Asegúrese de que el archivo sea un PDF válido o descárguelo para verlo.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <select id="tecnico-options" style="display: none;">
        {% for tecnico in users %}
        {% if tecnico.role == 'tecnico' %}
        <option value="{{ tecnico.username }}">{{ tecnico.nombre }} {{ tecnico.apellido }}</option>
        {% endif %}
        {% endfor %}
    </select>
    <select id="tipo-options" style="display: none;">
        {% for tipo in tipos_asesoria %}
        <option value="{{ tipo.nombre }}">{{ tipo.nombre }}</option>
        {% endfor %}
    </select>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>