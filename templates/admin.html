<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/y30hqcg3/45fd5a1a-670a-4ce5-8ac8-dc135faffeb8.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="admin no-animations" data-current-view="{{ current_section }}" data-current-role="admin">
    <div class="container-fluid">
        <div class="row">
            <nav class="col-lg-2 col-md-3 d-md-block sidebar py-4">
                <div class="navbar-brand mb-4 text-center">Conagopare Admin</div>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'oficios' else '' }}" href="#" onclick="showSection('oficios')">
                            <i class="bi bi-archive me-2"></i>Resumen de Oficios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'usuarios' else '' }}" href="#" onclick="showSection('usuarios')">
                            <i class="bi bi-people me-2"></i>Gestión de Usuarios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'tipos_asesoria' else '' }}" href="#" onclick="showSection('tipos_asesoria')">
                            <i class="bi bi-list-check me-2"></i>Gestión de Tipos de Asesoría
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'parroquias' else '' }}" href="#" onclick="showSection('parroquias')">
                            <i class="bi bi-geo-alt me-2"></i>Gestión de Parroquias
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'mantenimiento' else '' }}" href="#" onclick="showSection('mantenimiento')">
                            <i class="bi bi-tools me-2"></i>Mantenimiento
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'logs' else '' }}" href="#" onclick="showSection('logs')">
                            <i class="bi bi-journal-text me-2"></i>Logs del Sistema
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link {{ 'active' if current_section == 'errores' else '' }}" href="#" onclick="showSection('errores')">
                            <i class="bi bi-exclamation-triangle me-2"></i>Errores del Sistema
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                        </a>
                    </li>
                </ul>
            </nav>
            <main class="col-lg-10 col-md-9 ms-sm-auto main-content">
                <div class="container-fluid">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible show"
                        role="alert">
                        {{ message }}
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <div id="section-oficios" class="card-section {{ 'active' if current_section == 'oficios' else 'd-none' }}">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 class="mb-0">{{ oficios|length }}</h4>
                                                <p class="mb-0">Total Oficios</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="bi bi-file-text fs-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 class="mb-0">{{ oficios|selectattr('estado', 'equalto', 'pendiente')|list|length }}</h4>
                                                <p class="mb-0">Pendientes</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="bi bi-clock fs-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 class="mb-0">{{ oficios|selectattr('estado', 'equalto', 'designado')|list|length }}</h4>
                                                <p class="mb-0">Designados</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="bi bi-person-check fs-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4 class="mb-0">{{ oficios|selectattr('estado', 'equalto', 'completado')|list|length }}</h4>
                                                <p class="mb-0">Completados</p>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="bi bi-check-circle fs-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-earmark-text me-2"></i>Gestión de Oficios
                                </div>
                                <div>
                                    <input type="text" class="form-control form-control-sm" id="filterValueOficios"
                                        placeholder="Buscar por ID, número, parroquia..." style="width: 250px;">
                                </div>
                            </div>
                            <div class="card-body">
                            {% if oficios %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Número Oficio</th>
                                            <th>Estado</th>
                                            <th>Técnico</th>
                                            <th>Sub-Estado</th>
                                            <th>Fecha Recibido</th>
                                            <th>Fecha Enviado</th>
                                            <th>Fecha Designación</th>
                                            <th>Anexos</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for oficio in oficios %}
                                        <tr>
                                            <td>{{ oficio.id_secuencial }}</td>
                                            <td>{{ oficio.numero_oficio }}</td>
                                            <td>{{ oficio.estado }}</td>
                                            <td>
                                                {% if oficio.assignments %}
                                                {% for a in oficio.assignments %}
                                                {{ a.tecnico }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                                {% else %}
                                                Pendiente
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if oficio.assignments %}
                                                {% for a in oficio.assignments %}
                                                {{ a.sub_estado or 'Asignado' }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                                {% else %}
                                                N/A
                                                {% endif %}
                                            </td>
                                            <td>{{ oficio.fecha_recibido_formatted }}</td>
                                            <td>{{ oficio.fecha_enviado_formatted }}</td>
                                            <td>{{ oficio.fecha_designacion_formatted or 'N/A' }}</td>
                                            <td>
                                                {% set has_anexo = false %}
                                                {% for a in oficio.assignments %}
                                                {% if a.anexo_nombre %}
                                                {% set has_anexo = true %}
                                                {% endif %}
                                                {% endfor %}
                                                {{ 'True' if has_anexo else 'False' }}
                                                {% if has_anexo %}
                                                <div>
                                                    {% for a in oficio.assignments %}
                                                    {% if a.anexo_nombre %}
                                                    <button type="button" class="btn btn-primary btn-sm preview-btn"
                                                        data-bs-toggle="modal" data-bs-target="#previewModal"
                                                        data-id="{{ oficio._id }}"
                                                        data-anexo-nombre="{{ a.anexo_nombre }}"
                                                        data-anexo-tecnico="{{ a.tecnico }}">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <a href="{{ url_for('download_anexo', oficio_id=oficio._id, tecnico=a.tecnico) }}"
                                                        class="btn btn-info btn-sm" title="Descargar {{ a.anexo_nombre }}">
                                                        <i class="bi bi-download"></i>
                                                    </a>
                                                    {% endif %}
                                                {% endfor %}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm edit-btn"
                                                    data-bs-toggle="modal" data-bs-target="#editModal"
                                                    data-id="{{ oficio._id }}"
                                                    data-fecha-enviado="{{ oficio.fecha_enviado }}"
                                                    data-numero-oficio="{{ oficio.numero_oficio }}"
                                                    data-gad-parroquial="{{ oficio.gad_parroquial }}"
                                                    data-canton="{{ oficio.canton }}"
                                                    data-detalle="{{ oficio.detalle }}"
                                                    data-assignments="{{ oficio.assignments | default([]) | tojson }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="oficio_id" value="{{ oficio._id }}">
                                                    <input type="hidden" name="current_section" value="oficios">
                                                    <button type="submit" class="btn btn-danger btn-sm"
                                                        name="delete_oficio"
                                                        onclick="return confirm('¿Está seguro de eliminar este registro?')"><i
                                                            class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                {% if oficio.archivo_nombre %}
                                                <a href="{{ url_for('download', oficio_id=oficio._id) }}" class="btn btn-sm btn-info">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">Sin oficios registrados.</p>
                            {% endif %}
                            </div>
                        </div>
                    </div>

                    <div id="section-usuarios" class="card-section {{ 'active' if current_section == 'usuarios' else 'd-none' }}">
                        <!-- Create User Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-person-plus me-2"></i>Crear Nuevo Usuario
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    <input type="hidden" name="current_section" value="usuarios">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre</label>
                                            <input type="text" class="form-control" name="nombre" placeholder="Ingrese el nombre" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Apellido</label>
                                            <input type="text" class="form-control" name="apellido" placeholder="Ingrese el apellido" required>
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre de Usuario</label>
                                            <input type="text" class="form-control" name="username" placeholder="Ingrese el username" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email (opcional)</label>
                                            <input type="email" class="form-control" name="email" placeholder="correo@ejemplo.com">
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Contraseña</label>
                                            <input type="password" class="form-control" name="password" placeholder="Ingrese la contraseña" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Rol</label>
                                            <select class="form-select" name="role" required>
                                                <option value="">Seleccione un rol</option>
                                                {% for role in roles %}
                                                <option value="{{ role }}">{{ role.title() }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-12">
                                            <button type="submit" class="btn btn-success w-100" name="create_user">
                                                <i class="bi bi-person-plus"></i> Crear Usuario
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Users Management Card -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-people me-2"></i>Usuarios Existentes ({{ users|length }})
                            </div>
                            <div class="card-body">
                                {% if users %}
                                <div class="row g-3">
                                    {% for user in users %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card border-{{ 'warning' if user.role == 'admin' else 'secondary' }}">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span class="fw-bold">{{ user.nombre or 'Sin nombre' }} {{ user.apellido or '' }}</span>
                                                <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' if user.role == 'tecnico' else 'success' if user.role == 'designer' else 'warning' if user.role == 'receiver' else 'secondary' }}">{{ user.role.title() }}</span>
                                            </div>
                                            <div class="card-body">
                                                <form method="POST">
                                                    <input type="hidden" name="user_id" value="{{ user._id }}">
                                                    <input type="hidden" name="current_section" value="usuarios">
                                                    <div class="mb-2">
                                                        <label class="form-label small">Nombre</label>
                                                        <input type="text" class="form-control form-control-sm" name="nombre" value="{{ user.nombre or '' }}" required>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Apellido</label>
                                                        <input type="text" class="form-control form-control-sm" name="apellido" value="{{ user.apellido or '' }}" required>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Usuario</label>
                                                        <input type="text" class="form-control form-control-sm" name="username" value="{{ user.username }}" required>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Rol</label>
                                                        <select class="form-select form-select-sm" name="role" required>
                                                            {% for role in roles %}
                                                            <option value="{{ role }}" {% if user.role == role %}selected{% endif %}>{{ role.title() }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Email</label>
                                                        <input type="email" class="form-control form-control-sm" name="email" value="{{ user.email or '' }}" placeholder="correo@ejemplo.com">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small">Nueva Contraseña</label>
                                                        <input type="password" class="form-control form-control-sm" name="password" placeholder="Dejar vacío para mantener">
                                                    </div>
                                                    <div class="d-grid gap-2">
                                                        <button type="submit" class="btn btn-primary btn-sm" name="edit_user">
                                                            <i class="bi bi-save"></i> Actualizar
                                                        </button>
                                                        <button type="submit" class="btn btn-danger btn-sm" name="delete_user" 
                                                            onclick="return confirm('¿Está seguro de eliminar este usuario?')" 
                                                            {% if user.username == session.user %}disabled title="No puedes eliminarte a ti mismo"{% endif %}>
                                                            <i class="bi bi-trash"></i> Eliminar
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted text-center">No hay usuarios registrados.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div id="section-tipos_asesoria" class="card-section {{ 'active' if current_section == 'tipos_asesoria' else 'd-none' }}">
                        <!-- Add Advisory Type Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-plus-circle me-2"></i>Añadir Tipo de Asesoría
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    <input type="hidden" name="current_section" value="tipos_asesoria">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre del Tipo de Asesoría</label>
                                            <input type="text" class="form-control" name="nombre" placeholder="Ej: Asesoría Técnica, Inspección, etc." required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Técnico Asignado</label>
                                            <select class="form-select" name="tecnico_asignado">
                                                <option value="">Disponible para todos</option>
                                                {% for user in tecnicos %}
                                                <option value="{{ user.username }}">{{ user.full_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="submit" class="btn btn-success" name="add_tipo_asesoria">
                                            <i class="bi bi-plus-circle"></i> Añadir Tipo de Asesoría
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Advisory Types Management Card -->
                        <div class="card">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-list-check me-2"></i>Tipos de Asesoría Existentes ({{ tipos_asesoria|length }})
                                </div>
                                <div>
                                    <input type="text" class="form-control form-control-sm" id="filterTiposAsesoria"
                                        placeholder="Buscar por nombre o técnico..." style="width: 250px;">
                                </div>
                            </div>
                            <div class="card-body">
                                {% if tipos_asesoria %}
                                
                                <!-- General Advisory Types -->
                                {% set general_tipos = [] %}
                                {% for tipo in tipos_asesoria %}
                                {% if not tipo.tecnico_asignado %}
                                {% set _ = general_tipos.append(tipo) %}
                                {% endif %}
                                {% endfor %}
                                
                                {% if general_tipos %}
                                <div class="mb-4">
                                    <h6 class="text-secondary mb-3"><i class="bi bi-globe me-2"></i>Asesorías Generales</h6>
                                    <div class="row g-3">
                                        {% for tipo in general_tipos %}
                                        <div class="col-md-6 col-lg-4 tipo-asesoria-card" data-nombre="{{ tipo.nombre|lower }}" data-tecnico="general">
                                            <div class="card border-secondary">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="fw-bold text-primary">{{ tipo.nombre }}</span>
                                                        <span class="badge bg-secondary">General</span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <form method="POST">
                                                        <input type="hidden" name="tipo_id" value="{{ tipo._id }}">
                                                        <input type="hidden" name="current_section" value="tipos_asesoria">
                                                        <div class="mb-2">
                                                            <label class="form-label small">Nombre</label>
                                                            <input type="text" class="form-control form-control-sm" name="edit_nombre" value="{{ tipo.nombre }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label small">Técnico Asignado</label>
                                                            <select class="form-select form-select-sm" name="edit_tecnico_asignado">
                                                                <option value="" selected>Disponible para todos</option>
                                                                {% for user in tecnicos %}
                                                                <option value="{{ user.username }}">{{ user.full_name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-primary btn-sm" name="edit_tipo_asesoria">
                                                                <i class="bi bi-save"></i> Actualizar
                                                            </button>
                                                            <button type="submit" class="btn btn-danger btn-sm" name="delete_tipo_asesoria" 
                                                                onclick="return confirm('¿Está seguro de eliminar este tipo de asesoría?')">
                                                                <i class="bi bi-trash"></i> Eliminar
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- User-Specific Advisory Types -->
                                {% set processed_users = [] %}
                                {% for user in users %}
                                {% set user_asesorias = [] %}
                                {% for tipo in tipos_asesoria %}
                                {% if tipo.tecnico_asignado == user.username %}
                                {% set _ = user_asesorias.append(tipo) %}
                                {% endif %}
                                {% endfor %}
                                
                                {% if user_asesorias %}
                                <div class="mb-4">
                                    <h6 class="text-info mb-3"><i class="bi bi-person-gear me-2"></i>{{ user.nombre }} {{ user.apellido }} ({{ user.role.title() }})</h6>
                                    <div class="row g-3">
                                        {% for tipo in user_asesorias %}
                                        <div class="col-md-6 col-lg-4 tipo-asesoria-card" data-nombre="{{ tipo.nombre|lower }}" data-tecnico="{{ (user.nombre + ' ' + user.apellido)|lower }}">
                                            <div class="card border-info">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="fw-bold text-primary">{{ tipo.nombre }}</span>
                                                        <span class="badge bg-info">Específico</span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <form method="POST">
                                                        <input type="hidden" name="tipo_id" value="{{ tipo._id }}">
                                                        <input type="hidden" name="current_section" value="tipos_asesoria">
                                                        <div class="mb-2">
                                                            <label class="form-label small">Nombre</label>
                                                            <input type="text" class="form-control form-control-sm" name="edit_nombre" value="{{ tipo.nombre }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label small">Técnico Asignado</label>
                                                            <select class="form-select form-select-sm" name="edit_tecnico_asignado">
                                                                <option value="">Disponible para todos</option>
                                                                {% for tecnico in tecnicos %}
                                                                <option value="{{ tecnico.username }}" {% if tipo.tecnico_asignado == tecnico.username %}selected{% endif %}>{{ tecnico.full_name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-primary btn-sm" name="edit_tipo_asesoria">
                                                                <i class="bi bi-save"></i> Actualizar
                                                            </button>
                                                            <button type="submit" class="btn btn-danger btn-sm" name="delete_tipo_asesoria" 
                                                                onclick="return confirm('¿Está seguro de eliminar este tipo de asesoría?')">
                                                                <i class="bi bi-trash"></i> Eliminar
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                
                                {% else %}
                                <p class="text-muted text-center">No hay tipos de asesoría registrados.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div id="section-parroquias" class="card-section {{ 'active' if current_section == 'parroquias' else 'd-none' }}">
                        <!-- Add Parish Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-geo-alt-fill me-2"></i>Añadir Nueva Parroquia
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    <input type="hidden" name="current_section" value="parroquias">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nombre de la Parroquia</label>
                                            <input type="text" class="form-control" name="parroquia" placeholder="Ingrese el nombre de la parroquia" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Cantón</label>
                                            <input type="text" class="form-control" name="canton" placeholder="Ingrese el cantón" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success" name="add_parroquia">
                                        <i class="bi bi-plus-circle"></i> Añadir Parroquia
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Parishes Management Card -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-geo-alt me-2"></i>Parroquias Existentes ({{ parroquias|length }})
                            </div>
                            <div class="card-body">
                                {% if parroquias %}
                                <div class="row g-3">
                                    {% for p in parroquias %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card border-secondary">
                                            <div class="card-header bg-light">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="fw-bold text-primary">{{ p.parroquia }}</span>
                                                    <small class="text-muted">{{ p.canton }}</small>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <form method="POST">
                                                    <input type="hidden" name="parroquia_id" value="{{ p._id }}">
                                                    <input type="hidden" name="current_section" value="parroquias">
                                                    <div class="mb-2">
                                                        <label class="form-label small">Parroquia</label>
                                                        <input type="text" class="form-control form-control-sm" name="edit_parroquia" value="{{ p.parroquia }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small">Cantón</label>
                                                        <input type="text" class="form-control form-control-sm" name="edit_canton" value="{{ p.canton }}" required>
                                                    </div>
                                                    <div class="d-grid gap-2">
                                                        <button type="submit" class="btn btn-primary btn-sm" name="edit_parroquia">
                                                            <i class="bi bi-save"></i> Actualizar
                                                        </button>
                                                        <button type="submit" class="btn btn-danger btn-sm" name="delete_parroquia" 
                                                            onclick="return confirm('¿Está seguro de eliminar esta parroquia?')">
                                                            <i class="bi bi-trash"></i> Eliminar
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted text-center">No hay parroquias registradas.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div id="section-mantenimiento" class="card card-section {{ 'active' if current_section == 'mantenimiento' else 'd-none' }}">
                        <div class="card-header bg-warning text-dark">
                            <i class="bi bi-tools me-2"></i>Mantenimiento del Sistema
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Atención:</strong> Estas operaciones eliminarán datos permanentemente. Use con precaución.
                            </div>
                            
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card border-danger">
                                        <div class="card-header bg-danger text-white">
                                            <i class="bi bi-trash me-2"></i>Limpiar Oficios
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">Elimina todos los oficios y sus archivos asociados.</p>
                                            <form method="POST" onsubmit="return confirm('¿Está seguro de eliminar TODOS los oficios? Esta acción no se puede deshacer.')">
                                                <input type="hidden" name="current_section" value="mantenimiento">
                                                <button type="submit" name="clear_oficios" class="btn btn-danger">
                                                    <i class="bi bi-trash"></i> Eliminar Todos los Oficios
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <i class="bi bi-bell-slash me-2"></i>Limpiar Notificaciones
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">Elimina todas las notificaciones del sistema.</p>
                                            <form method="POST" onsubmit="return confirm('¿Está seguro de eliminar todas las notificaciones?')">
                                                <input type="hidden" name="current_section" value="mantenimiento">
                                                <button type="submit" name="clear_notifications" class="btn btn-warning">
                                                    <i class="bi bi-bell-slash"></i> Limpiar Notificaciones
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <i class="bi bi-archive me-2"></i>Limpiar Archivos Huérfanos
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">Elimina archivos que no están asociados a ningún oficio.</p>
                                            <form method="POST" onsubmit="return confirm('¿Está seguro de limpiar archivos huérfanos?')">
                                                <input type="hidden" name="current_section" value="mantenimiento">
                                                <button type="submit" name="clear_orphan_files" class="btn btn-info">
                                                    <i class="bi bi-archive"></i> Limpiar Archivos
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-secondary">
                                        <div class="card-header bg-secondary text-white">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Reiniciar IDs Secuenciales
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">Reinicia la numeración secuencial de oficios para el año actual.</p>
                                            <form method="POST" onsubmit="return confirm('¿Está seguro de reiniciar los IDs secuenciales?')">
                                                <input type="hidden" name="current_section" value="mantenimiento">
                                                <button type="submit" name="reset_sequential_ids" class="btn btn-secondary">
                                                    <i class="bi bi-arrow-clockwise"></i> Reiniciar IDs
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección de Respaldos -->
                            <div class="mt-4">
                                <h6><i class="bi bi-shield-check me-2"></i>Gestión de Respaldos por Año</h6>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card border-success">
                                            <div class="card-header bg-success text-white">
                                                <i class="bi bi-download me-2"></i>Crear Respaldo
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text">Crea un respaldo de todos los oficios de un año específico.</p>
                                                <form method="POST">
                                                    <input type="hidden" name="current_section" value="mantenimiento">
                                                    <div class="mb-3">
                                                        <label class="form-label">Año a respaldar:</label>
                                                        <select class="form-select" name="backup_year" required>
                                                            <option value="">Seleccione un año</option>
                                                            {% for year in available_years %}
                                                            <option value="{{ year }}">{{ year }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <button type="submit" name="backup_year" class="btn btn-success">
                                                        <i class="bi bi-download"></i> Crear Respaldo
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <i class="bi bi-upload me-2"></i>Restaurar Respaldo
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text">Restaura los oficios desde un respaldo existente.</p>
                                                <form method="POST" onsubmit="return confirm('¿Está seguro de restaurar este respaldo? Se eliminarán los datos actuales del año seleccionado.')">
                                                    <input type="hidden" name="current_section" value="mantenimiento">
                                                    <div class="mb-3">
                                                        <label class="form-label">Respaldo a restaurar:</label>
                                                        <select class="form-select" name="restore_year" required>
                                                            <option value="">Seleccione un respaldo</option>
                                                            {% for backup in backup_collections %}
                                                            <option value="{{ backup.year }}">{{ backup.year }} ({{ backup.count }} oficios)</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <button type="submit" name="restore_year" class="btn btn-primary">
                                                        <i class="bi bi-upload"></i> Restaurar Respaldo
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if backup_collections %}
                                <div class="mt-3">
                                    <h6>Respaldos Disponibles:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Año</th>
                                                    <th>Cantidad de Oficios</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for backup in backup_collections %}
                                                <tr>
                                                    <td><strong>{{ backup.year }}</strong></td>
                                                    <td>{{ backup.count }} oficios</td>
                                                    <td>
                                                        <span class="badge bg-success">Disponible</span>
                                                        <a href="{{ url_for('download_backup', year=backup.year) }}" class="btn btn-sm btn-outline-primary ms-2">
                                                            <i class="bi bi-download"></i> Descargar
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="mt-4">
                                <h6>Estadísticas del Sistema</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-primary">{{ stats.pendientes + stats.designados + stats.completados }}</h5>
                                                <p class="card-text">Total Oficios</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-warning">{{ stats.pendientes }}</h5>
                                                <p class="card-text">Pendientes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-info">{{ stats.designados }}</h5>
                                                <p class="card-text">Designados</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-success">{{ stats.completados }}</h5>
                                                <p class="card-text">Completados</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="section-logs" class="card card-section {{ 'active' if current_section == 'logs' else 'd-none' }}">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-journal-text me-2"></i>Logs del Sistema
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Actividades de Usuarios</h6>
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="current_section" value="logs">
                                    <button type="submit" name="clear_logs" class="btn btn-warning btn-sm" onclick="return confirm('¿Está seguro de limpiar todos los logs?')">
                                        <i class="bi bi-trash"></i> Limpiar Logs
                                    </button>
                                </form>
                            </div>
                            {% if logs %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Usuario</th>
                                            <th>Acción</th>
                                            <th>Detalles</th>
                                            <th>IP</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for log in logs %}
                                        <tr>
                                            <td>{{ log.timestamp_formatted }}</td>
                                            <td>{{ log.username }}</td>
                                            <td><span class="badge bg-{{ log.action_color }}">{{ log.action }}</span></td>
                                            <td>{{ log.details }}</td>
                                            <td>{{ log.ip_address }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">No hay logs registrados.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div id="section-errores" class="card card-section {{ 'active' if current_section == 'errores' else 'd-none' }}">
                        <div class="card-header bg-danger text-white">
                            <i class="bi bi-exclamation-triangle me-2"></i>Errores del Sistema
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Errores y Excepciones</h6>
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="current_section" value="errores">
                                    <button type="submit" name="clear_errors" class="btn btn-warning btn-sm" onclick="return confirm('¿Está seguro de limpiar todos los errores?')">
                                        <i class="bi bi-trash"></i> Limpiar Errores
                                    </button>
                                </form>
                            </div>
                            {% if errors %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Nivel</th>
                                            <th>Usuario</th>
                                            <th>Endpoint</th>
                                            <th>Error</th>
                                            <th>Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for error in errors %}
                                        <tr>
                                            <td>{{ error.timestamp_formatted }}</td>
                                            <td><span class="badge bg-{{ error.level_color }}">{{ error.level }}</span></td>
                                            <td>{{ error.username or 'Anónimo' }}</td>
                                            <td>{{ error.endpoint }}</td>
                                            <td>{{ error.error_type }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#error-{{ loop.index }}">
                                                    Ver Detalles
                                                </button>
                                                <div class="collapse mt-2" id="error-{{ loop.index }}">
                                                    <div class="card card-body">
                                                        <pre class="mb-0">{{ error.details }}</pre>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">No hay errores registrados.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Oficio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" id="editForm" enctype="multipart/form-data">
                        <input type="hidden" name="oficio_id" id="edit_oficio_id">
                        <input type="hidden" name="current_section" value="oficios">
                        <div class="mb-3">
                            <label for="edit_fecha_enviado" class="form-label">Fecha Enviado</label>
                            <input type="date" class="form-control" name="fecha_enviado" id="edit_fecha_enviado"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_numero_oficio" class="form-label">Número de Oficio</label>
                            <input type="text" class="form-control" name="numero_oficio" id="edit_numero_oficio"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_gad_parroquial" class="form-label">GAD Parroquial</label>
                            <select class="form-select" name="gad_parroquial" id="edit_gad_parroquial" required
                                onchange="updateCantonEdit()">
                                <option value="">Seleccione GAD Parroquial</option>
                                {% for p in parroquias %}
                                <option value="{{ p.parroquia }}">{{ p.parroquia }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_canton" class="form-label">Cantón</label>
                            <input type="text" class="form-control" name="canton" id="edit_canton" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_detalle" class="form-label">Detalle</label>
                            <textarea class="form-control" name="detalle" id="edit_detalle" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Asignaciones</label>
                            <div id="edit_tecnico_asesoria_pairs">
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm mt-2 add-pair">Añadir
                                Asignación</button>
                        </div>
                        <div class="mb-3">
                            <label for="edit_archivo" class="form-label">Subir Archivo (opcional)</label>
                            <input type="file" class="form-control" id="edit_archivo" name="archivo" accept=".pdf,.doc,.docx,.jpg,.png">
                        </div>
                        <button type="submit" class="btn btn-primary" name="edit_oficio">Actualizar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Vista Previa del Anexo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContainer">
                        <iframe id="previewFrame" title="Vista previa del archivo" style="width: 100%; height: 500px;"></iframe>
                        <div id="previewError" class="d-none text-danger text-center">
                            No se puede mostrar la vista previa del archivo. Asegúrese de que el archivo sea un PDF válido o descárguelo para verlo.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <select id="tecnico-options" style="display: none;">
        {% for tecnico in tecnicos %}
        <option value="{{ tecnico.username }}">{{ tecnico.full_name }}</option>
        {% endfor %}
    </select>
    <select id="tipo-options" style="display: none;">
        {% for tipo in tipos_asesoria %}
        <option value="{{ tipo.nombre }}">{{ tipo.nombre }}</option>
        {% endfor %}
    </select>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterTiposAsesoria = document.getElementById('filterTiposAsesoria');
        if (filterTiposAsesoria) {
            filterTiposAsesoria.addEventListener('input', function() {
                const filterValue = this.value.toLowerCase();
                const cards = document.querySelectorAll('.tipo-asesoria-card');
                
                cards.forEach(function(card) {
                    const nombre = card.getAttribute('data-nombre') || '';
                    const tecnico = card.getAttribute('data-tecnico') || '';
                    
                    if (nombre.includes(filterValue) || tecnico.includes(filterValue)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }
    });
    </script>
</body>

</html>